# ----------------------------------------------------------------------
# Stage 1: Builder
# Purpose: Install dependencies, compile any Python C-extension packages,
#          and run collectstatic. This stage contains all the necessary
#          build tools (gcc, build-essential) which are discarded later.
# ----------------------------------------------------------------------
FROM python:3.11-slim-bullseye as builder

# Set crucial environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=your_project.settings.production
# Define working directory
WORKDIR /usr/src/app

# Install system dependencies and build tools needed for Python packages
# Build tools (gcc, build-essential) are still necessary for many Python
# packages that rely on C-extensions (e.g., cryptography, Pillow, etc.).
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements file early to leverage Docker caching.
COPY requirements.txt .

# Install Python packages
RUN pip install --no-cache-dir -r requirements.txt

# Copy all application code
COPY . .

# Collect static files. STATIC_ROOT must be defined in Django settings.
RUN python manage.py collectstatic --noinput

# ----------------------------------------------------------------------
# Stage 2: Production
# Purpose: Create a minimal final image that only includes the runtime
#          Python interpreter, installed packages, minimal system libs,
#          and the application code.
# ----------------------------------------------------------------------
FROM python:3.11-slim-bullseye as production

# Set crucial environment variables again
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=project.settings.production

# Create a dedicated non-root user for security (best practice)
RUN groupadd --system appgroup && useradd --system --gid appgroup appuser

# Install only the runtime system libraries needed.
# Since no external database connectors (like libpq5 or libmysqlclient21) are specified,
# this step only handles update/cleanup for a truly minimal runtime environment.
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    # Add minimal runtime libraries here if needed
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Define working directory
WORKDIR /usr/src/app

# Copy installed Python packages from the builder stage
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages

# Copy application source code (including collected static files)
COPY --from=builder /usr/src/app .

# Set ownership to the non-root user
RUN chown -R appuser:appgroup /usr/src/app

# Switch to the non-root user
USER appuser

# Expose the standard Gunicorn port
EXPOSE 8000

# Start the application using Gunicorn (a production WSGI server)
# NOTE: Replace 'your_project' with your actual Django project directory name.
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "project.wsgi:application"]
